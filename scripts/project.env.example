#!/bin/bash
# Centralized gofr-np configuration.
# Canonical location for sourced env defaults.
#
# NOTE: This file is designed to be sourced.

# Determine project root
if [ -z "${GOFR_NP_ROOT:-}" ] && [ -z "${GOFRNP_ROOT:-}" ]; then
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        GOFR_NP_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        GOFR_NP_ROOT="${PROJECT_ROOT}"
    else
        GOFR_NP_ROOT="$(cd "." && pwd)"
    fi
fi

# Keep both canonical and legacy root vars in sync
export GOFR_NP_ROOT="${GOFR_NP_ROOT:-${GOFRNP_ROOT:-}}"
export GOFRNP_ROOT="${GOFRNP_ROOT:-${GOFR_NP_ROOT}}"

# Environment mode (TEST/PROD)
export GOFR_NP_ENV="${GOFR_NP_ENV:-${GOFRNP_ENV:-TEST}}"
export GOFRNP_ENV="${GOFRNP_ENV:-${GOFR_NP_ENV}}"

# Ports SSOT
_PORTS_ENV="${GOFR_NP_ROOT}/lib/gofr-common/config/gofr_ports.env"
if [ -f "${_PORTS_ENV}" ]; then
    # shellcheck source=/dev/null
    source "${_PORTS_ENV}"
fi
unset _PORTS_ENV

# Directories
export GOFR_NP_LOGS="${GOFR_NP_LOGS:-${GOFR_NP_ROOT}/logs}"

if [ "$GOFR_NP_ENV" = "PROD" ]; then
    export GOFR_NP_DATA="${GOFR_NP_DATA:-${GOFR_NP_ROOT}/data}"
else
    export GOFR_NP_DATA="${GOFR_NP_DATA:-${GOFR_NP_ROOT}/test/data}"
fi

export GOFR_NP_STORAGE="${GOFR_NP_STORAGE:-${GOFR_NP_DATA}/storage}"

# Legacy directory vars
export GOFRNP_LOGS="${GOFRNP_LOGS:-${GOFR_NP_LOGS}}"
export GOFRNP_DATA="${GOFRNP_DATA:-${GOFR_NP_DATA}}"
export GOFRNP_STORAGE="${GOFRNP_STORAGE:-${GOFR_NP_STORAGE}}"

# Token store (legacy)
export GOFRNP_TOKEN_STORE="${GOFRNP_TOKEN_STORE:-${GOFRNP_LOGS}/gofrnp_tokens.json}"

# Create required directories (do not fail if they already exist)
mkdir -p "$GOFR_NP_LOGS" 2>/dev/null || true
mkdir -p "$GOFR_NP_STORAGE" 2>/dev/null || true

# Network defaults
export GOFRNP_HOST="${GOFRNP_HOST:-0.0.0.0}"
export GOFRNP_DOCKER_NETWORK="${GOFRNP_DOCKER_NETWORK:-gofr-net}"

# Map canonical ports into legacy GOFRNP_* vars for backward compatibility
if [ -n "${GOFR_NP_MCP_PORT:-}" ]; then
    export GOFRNP_MCP_PORT="${GOFRNP_MCP_PORT:-${GOFR_NP_MCP_PORT}}"
fi
if [ -n "${GOFR_NP_MCPO_PORT:-}" ]; then
    export GOFRNP_MCPO_PORT="${GOFRNP_MCPO_PORT:-${GOFR_NP_MCPO_PORT}}"
fi
if [ -n "${GOFR_NP_WEB_PORT:-}" ]; then
    export GOFRNP_WEB_PORT="${GOFRNP_WEB_PORT:-${GOFR_NP_WEB_PORT}}"
fi

export GOFRNP_WEBUI_PORT="${GOFRNP_WEBUI_PORT:-9090}"
