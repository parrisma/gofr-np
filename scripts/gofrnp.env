#!/bin/bash
# Centralized GOFRNP Configuration
# Source this file in all scripts and tests:
#   source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/gofrnp.env"
#
# Environment Modes:
#   GOFRNP_ENV=PROD  => uses $GOFRNP_ROOT/data
#   GOFRNP_ENV=TEST  => uses $GOFRNP_ROOT/test/data (default)
#
# All ports and hosts can be overridden via environment variables before sourcing.

# Determine GOFRNP_ROOT - the project root directory
if [ -z "${GOFRNP_ROOT:-}" ]; then
    # Try to get from BASH_SOURCE first (when directly sourced)
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        GOFRNP_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        # Use PROJECT_ROOT if set by caller (run_tests.sh sets this)
        GOFRNP_ROOT="${PROJECT_ROOT}"
    else
        # Fallback to current directory
        GOFRNP_ROOT="$(cd "." && pwd)"
    fi
fi

# Set environment mode (PROD or TEST)
export GOFRNP_ENV="${GOFRNP_ENV:-TEST}"

# Core directories
export GOFRNP_ROOT
export GOFRNP_LOGS="${GOFRNP_ROOT}/logs"

# Select data directory based on environment
if [ "$GOFRNP_ENV" = "PROD" ]; then
    export GOFRNP_DATA="${GOFRNP_ROOT}/data"
else
    export GOFRNP_DATA="${GOFRNP_ROOT}/test/data"
fi

# Data subdirectories (based on GOFRNP_ENV)
export GOFRNP_STORAGE="${GOFRNP_DATA}/storage"

# Token store (always in logs directory)
export GOFRNP_TOKEN_STORE="${GOFRNP_LOGS}/gofrnp_tokens.json"

# Create required directories if they don't exist
mkdir -p "$GOFRNP_LOGS"
mkdir -p "$GOFRNP_STORAGE"

# =============================================================================
# Network Configuration
# =============================================================================
export GOFRNP_HOST="${GOFRNP_HOST:-0.0.0.0}"
export GOFRNP_DOCKER_NETWORK="${GOFRNP_DOCKER_NETWORK:-gofr-net}"

# =============================================================================
# Server Ports (all configurable via environment)
# =============================================================================
# Port configuration - single source of truth
# Source ports from lib/gofr-common/config/gofr_ports.env and map into legacy
# GOFRNP_* variables for backward compatibility.
PORTS_ENV="${GOFRNP_ROOT}/lib/gofr-common/config/gofr_ports.env"
if [ -f "${PORTS_ENV}" ]; then
    set -a
    source "${PORTS_ENV}"
    set +a
else
    echo "ERROR: Missing port config: ${PORTS_ENV}" >&2
    return 1
fi

# Map canonical GOFR_NP_* ports into legacy GOFRNP_* variables
export GOFRNP_MCP_PORT="${GOFR_NP_MCP_PORT}"
export GOFRNP_MCPO_PORT="${GOFR_NP_MCPO_PORT}"
export GOFRNP_WEB_PORT="${GOFR_NP_WEB_PORT}"
export GOFRNP_WEBUI_PORT="${GOFRNP_WEBUI_PORT:-9090}"
