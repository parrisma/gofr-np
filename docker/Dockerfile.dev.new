# GOFR-NP Development Image
# Uses shared gofr-base image from gofr-common
#
# Build: ./build-dev.sh
# Run:   ./run-dev.sh

FROM gofr-base:latest

# Install additional development tools
USER root
RUN apt-get update && apt-get install -y \
    gh \
    openssh-server \
    dnsutils \
    net-tools \
    netcat-openbsd \
    telnet \
    lsof \
    htop \
    strace \
    tcpdump \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Project-specific user setup (override base image user if needed)
ARG USER_NAME=gofr-np
ARG USER_UID=1000
ARG USER_GID=1000

# Create project-specific user (different from base gofr user)
RUN groupadd --gid ${USER_GID} ${USER_NAME} 2>/dev/null || true \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USER_NAME} 2>/dev/null || true \
    && echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${USER_NAME} \
    && chmod 0440 /etc/sudoers.d/${USER_NAME}

# Create project directory structure
RUN mkdir -p /home/${USER_NAME}/devroot/gofr-np/data \
    && mkdir -p /home/${USER_NAME}/devroot/gofr-common \
    && chown -R ${USER_NAME}:${USER_NAME} /home/${USER_NAME}/devroot

# Copy entrypoint script
COPY docker/entrypoint-dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Switch to project user
USER ${USER_NAME}
WORKDIR /home/${USER_NAME}/devroot/gofr-np

# Configure SSH for user
RUN mkdir -p /home/${USER_NAME}/.ssh && chmod 700 /home/${USER_NAME}/.ssh

# Create virtual environment
RUN uv venv /home/${USER_NAME}/devroot/gofr-np/.venv --python=python3.11

# Set environment variables
ENV VIRTUAL_ENV=/home/${USER_NAME}/devroot/gofr-np/.venv
ENV PATH="/home/${USER_NAME}/devroot/gofr-np/.venv/bin:$PATH"

# Use entrypoint to handle initialization
ENTRYPOINT ["/entrypoint.sh"]

# Keep container running
CMD ["tail", "-f", "/dev/null"]
