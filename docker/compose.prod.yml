# =============================================================================
# gofr-np Production Stack (Compose)
# =============================================================================
# Services:
# - mcp:  MCP server (streamable HTTP)
# - mcpo: MCPO proxy (OpenAPI wrapper)
# - web:  Web server
#
# Port configuration is sourced from lib/gofr-common/config/gofr_ports.env.
#
# This compose file expects the caller (docker/start-prod.sh) to source and
# export gofr_ports.env so that ${GOFR_NP_*} substitutions work.
# =============================================================================

name: gofr-np

x-gofr-ports: &gofr-ports
  env_file:
    - lib/gofr-common/config/gofr_ports.env

x-gofr-np-common: &gofr_np_common
  <<: *gofr-ports
  image: gofr-np-prod:latest
  restart: unless-stopped
  networks:
    - gofr-net

services:
  mcp:
    <<: *gofr_np_common
    container_name: gofr-np-mcp
    hostname: gofr-np-mcp
    user: root
    working_dir: /home/gofr-np
    entrypoint: ["/home/gofr-np/entrypoint-prod.sh"]
    command:
      - /home/gofr-np/.venv/bin/python
      - -m
      - app.main_mcp
      - --host
      - "0.0.0.0"
      - --port
      - "${GOFR_NP_MCP_PORT}"
      - --web-url
      - "http://gofr-np-web:${GOFR_NP_WEB_PORT}"
      - --proxy-url-mode
      - url
    environment:
      - GOFR_NP_ENV=PROD
      - GOFR_NP_LOG_LEVEL=${GOFR_NP_LOG_LEVEL:-INFO}
      # Auth - JWT signing secret is read from Vault at runtime by gofr-common
      - GOFR_NP_NO_AUTH=${GOFR_NP_NO_AUTH:-}
      - GOFR_NP_AUTH_BACKEND=${GOFR_NP_AUTH_BACKEND:-vault}
      - GOFR_NP_VAULT_URL=${GOFR_NP_VAULT_URL:-http://gofr-vault:${GOFR_VAULT_PORT}}
      - GOFR_NP_VAULT_PATH_PREFIX=${GOFR_NP_VAULT_PATH_PREFIX:-gofr/auth}
      - GOFR_NP_VAULT_MOUNT=${GOFR_NP_VAULT_MOUNT:-secret}
    ports:
      - "${GOFR_NP_MCP_HOST_PORT:-${GOFR_NP_MCP_PORT}}:${GOFR_NP_MCP_PORT}"
    volumes:
      - gofr-np-data:/home/gofr-np/data
      - gofr-np-prod-logs:/home/gofr-np/logs
      - gofr-secrets:/run/gofr-secrets:ro
    healthcheck:
      test:
        - CMD-SHELL
        - /home/gofr-np/.venv/bin/python -c "import os, socket; port=int(os.environ.get('GOFR_NP_MCP_PORT','8060')); s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', port)); s.close()"
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 10s

  mcpo:
    <<: *gofr_np_common
    container_name: gofr-np-mcpo
    hostname: gofr-np-mcpo
    user: gofr-np
    working_dir: /home/gofr-np
    entrypoint: []
    depends_on:
      mcp:
        condition: service_healthy
    command: >
      /home/gofr-np/.venv/bin/mcpo
      --host 0.0.0.0 --port ${GOFR_NP_MCPO_PORT} --server-type streamable-http
      -- http://gofr-np-mcp:${GOFR_NP_MCP_PORT}/mcp
    environment:
      - GOFR_NP_ENV=PROD
      - GOFR_NP_MCP_PORT=${GOFR_NP_MCP_PORT}
      - GOFR_NP_MCPO_PORT=${GOFR_NP_MCPO_PORT}
    ports:
      - "${GOFR_NP_MCPO_HOST_PORT:-${GOFR_NP_MCPO_PORT}}:${GOFR_NP_MCPO_PORT}"
    volumes:
      - gofr-np-prod-logs:/home/gofr-np/logs
      - gofr-secrets:/run/gofr-secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:${GOFR_NP_MCPO_PORT}/openapi.json || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  web:
    <<: *gofr_np_common
    container_name: gofr-np-web
    hostname: gofr-np-web
    user: root
    working_dir: /home/gofr-np
    entrypoint: ["/home/gofr-np/entrypoint-prod.sh"]
    command:
      - /home/gofr-np/.venv/bin/python
      - -m
      - app.main_web
      - --host
      - "0.0.0.0"
      - --port
      - "${GOFR_NP_WEB_PORT}"
    environment:
      - GOFR_NP_ENV=PROD
      - GOFR_NP_LOG_LEVEL=${GOFR_NP_LOG_LEVEL:-INFO}
      # Auth - JWT signing secret is read from Vault at runtime by gofr-common
      - GOFR_NP_NO_AUTH=${GOFR_NP_NO_AUTH:-}
      - GOFR_NP_AUTH_BACKEND=${GOFR_NP_AUTH_BACKEND:-vault}
      - GOFR_NP_VAULT_URL=${GOFR_NP_VAULT_URL:-http://gofr-vault:${GOFR_VAULT_PORT}}
      - GOFR_NP_VAULT_PATH_PREFIX=${GOFR_NP_VAULT_PATH_PREFIX:-gofr/auth}
      - GOFR_NP_VAULT_MOUNT=${GOFR_NP_VAULT_MOUNT:-secret}
    ports:
      - "${GOFR_NP_WEB_HOST_PORT:-${GOFR_NP_WEB_PORT}}:${GOFR_NP_WEB_PORT}"
    volumes:
      - gofr-np-data:/home/gofr-np/data
      - gofr-np-prod-logs:/home/gofr-np/logs
      - gofr-secrets:/run/gofr-secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:${GOFR_NP_WEB_PORT}/ping || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  gofr-net:
    name: gofr-net
    external: true

volumes:
  gofr-np-prod-logs:
    name: gofr-np-prod-logs
    external: false
  gofr-np-data:
    name: gofr-np-data
    external: false
  gofr-secrets:
    name: gofr-secrets
    external: true
