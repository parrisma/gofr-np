#!/bin/bash
# Build GOFR-NP development image
# Requires gofr-base:latest from gofr-common

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
COMMON_ROOT="$(cd "$PROJECT_ROOT/../gofr-common" && pwd)"

# Get current user's UID and GID for permission mapping
USER_UID=$(id -u)
USER_GID=$(id -g)

echo "======================================================================="
echo "Building GOFR-NP Development Image"
echo "======================================================================="
echo "User UID: $USER_UID"
echo "User GID: $USER_GID"
echo "======================================================================="

# Check if gofr-base:latest exists, build it if not
if ! docker image inspect gofr-base:latest >/dev/null 2>&1; then
    echo ""
    echo "Base image gofr-base:latest not found. Building it first..."
    echo ""
    if [ -f "$COMMON_ROOT/docker/build-base.sh" ]; then
        (cd "$COMMON_ROOT" && ./docker/build-base.sh)
    else
        echo "ERROR: Cannot find gofr-common/docker/build-base.sh"
        echo "Please build the base image first:"
        echo "  cd ../gofr-common && ./docker/build-base.sh"
        exit 1
    fi
fi

echo ""
echo "Building gofr-np-dev:latest..."

cd "$PROJECT_ROOT"

docker build \
    --build-arg USER_UID=$USER_UID \
    --build-arg USER_GID=$USER_GID \
    -f docker/Dockerfile.dev \
    -t gofr-np-dev:latest \
    .

echo ""
echo "======================================================================="
echo "Build complete: gofr-np-dev:latest"
echo "======================================================================="
echo ""
echo "Image size:"
docker images gofr-np-dev --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
