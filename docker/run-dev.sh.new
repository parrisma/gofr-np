#!/bin/bash
# Run GOFR-NP development container
# Uses gofr-np-dev:latest image (built from gofr-base:latest)
#
# Usage: ./run-dev.sh [options]
# Options:
#   --mcp-port PORT    MCP server port (default: 8020 or GOFRNP_MCP_PORT)
#   --mcpo-port PORT   MCPO proxy port (default: 8021 or GOFRNP_MCPO_PORT)
#   --web-port PORT    Web server port (default: 8022 or GOFRNP_WEB_PORT)
#   --network NAME     Docker network (default: gofr-net or GOFRNP_DOCKER_NETWORK)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
COMMON_ROOT="$(cd "$PROJECT_ROOT/../gofr-common" && pwd)"

# Container and image names
CONTAINER_NAME="gofr-np-dev"
IMAGE_NAME="gofr-np-dev:latest"

# Defaults from environment or hardcoded
MCP_PORT="${GOFRNP_MCP_PORT:-8020}"
MCPO_PORT="${GOFRNP_MCPO_PORT:-8021}"
WEB_PORT="${GOFRNP_WEB_PORT:-8022}"
DOCKER_NETWORK="${GOFRNP_DOCKER_NETWORK:-gofr-net}"

# Parse command line arguments
while [ $# -gt 0 ]; do
    case $1 in
        --mcp-port)
            MCP_PORT="$2"
            shift 2
            ;;
        --mcpo-port)
            MCPO_PORT="$2"
            shift 2
            ;;
        --web-port)
            WEB_PORT="$2"
            shift 2
            ;;
        --network)
            DOCKER_NETWORK="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--mcp-port PORT] [--mcpo-port PORT] [--web-port PORT] [--network NAME]"
            exit 1
            ;;
    esac
done

echo "======================================================================="
echo "Starting GOFR-NP Development Container"
echo "======================================================================="
echo "Ports: MCP=$MCP_PORT, MCPO=$MCPO_PORT, Web=$WEB_PORT"
echo "Network: $DOCKER_NETWORK"
echo "======================================================================="

# Create docker network if it doesn't exist
if ! docker network inspect $DOCKER_NETWORK >/dev/null 2>&1; then
    echo "Creating network: $DOCKER_NETWORK"
    docker network create $DOCKER_NETWORK
fi

# Create docker volume for persistent data
VOLUME_NAME="gofr-np-data-dev"
VOLUME_CREATED=false
if ! docker volume inspect $VOLUME_NAME >/dev/null 2>&1; then
    echo "Creating volume: $VOLUME_NAME"
    docker volume create $VOLUME_NAME
    VOLUME_CREATED=true
fi

# Stop and remove existing container
echo "Stopping existing container..."
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

echo ""
echo "Starting container..."
echo "  Source mount: $PROJECT_ROOT → /home/gofr-np/devroot/gofr-np"
echo "  Common mount: $COMMON_ROOT → /home/gofr-np/devroot/gofr-common"

docker run -d \
    --name $CONTAINER_NAME \
    --network $DOCKER_NETWORK \
    --user $(id -u):$(id -g) \
    -v "$PROJECT_ROOT":/home/gofr-np/devroot/gofr-np \
    -v "$COMMON_ROOT":/home/gofr-np/devroot/gofr-common:ro \
    -v "$HOME/.ssh:/home/gofr-np/.ssh:ro" \
    -v $VOLUME_NAME:/home/gofr-np/devroot/gofr-np/data \
    -p 0.0.0.0:$MCP_PORT:8020 \
    -p 0.0.0.0:$MCPO_PORT:8021 \
    -p 0.0.0.0:$WEB_PORT:8022 \
    $IMAGE_NAME

if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
    echo ""
    echo "Container $CONTAINER_NAME is running"
    
    # Fix volume permissions if newly created
    if [ "$VOLUME_CREATED" = true ]; then
        echo "Fixing volume permissions..."
        docker exec -u root $CONTAINER_NAME chown -R gofr-np:gofr-np /home/gofr-np/devroot/gofr-np/data 2>/dev/null || true
    fi
    
    echo ""
    echo "======================================================================="
    echo "Development Container Ready"
    echo "======================================================================="
    echo ""
    echo "Shell access:"
    echo "  docker exec -it $CONTAINER_NAME /bin/bash"
    echo ""
    echo "Endpoints (from host):"
    echo "  MCP Server:  http://localhost:$MCP_PORT/mcp"
    echo "  MCPO Proxy:  http://localhost:$MCPO_PORT"
    echo "  Web Server:  http://localhost:$WEB_PORT"
    echo ""
    echo "Mounts:"
    echo "  gofr-np source:     $PROJECT_ROOT (read-write)"
    echo "  gofr-common source: $COMMON_ROOT (read-only)"
    echo "  Data volume:        $VOLUME_NAME"
    echo ""
    echo "======================================================================="
else
    echo "ERROR: Container failed to start"
    docker logs $CONTAINER_NAME 2>&1 || true
    exit 1
fi
